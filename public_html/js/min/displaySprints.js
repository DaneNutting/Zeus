$(document).ready(function(){var getUrlParameter=function getUrlParameter(sParam){var sPageURL=decodeURIComponent(window.location.search.substring(1)),sURLVariables=sPageURL.split('&'),sParameterName,i;for(i=0;i<sURLVariables.length;i++){sParameterName=sURLVariables[i].split('=');if(sParameterName[0]===sParam){return sParameterName[1]===undefined?true:sParameterName[1];}}};var sprintNoFromURL=getUrlParameter("SprintNo");if(sprintNoFromURL!=null){$.ajax({type:"POST",data:{postedSprintNoFromURL:sprintNoFromURL},dataType:"json",url:"../php/SearchSprints.php",success:function load(result){populateSprints(result);dragAndDrop();}});}else{$.ajax({dataType:"json",url:"../php/SearchSprints.php",success:function normalload(result){populateSprints(result);dragAndDrop();}});}});function populateSprints(results){var getUrlParameter=function getUrlParameter(sParam){var sPageURL=decodeURIComponent(window.location.search.substring(1)),sURLVariables=sPageURL.split('&'),sParameterName,i;for(i=0;i<sURLVariables.length;i++){sParameterName=sURLVariables[i].split('=');if(sParameterName[0]===sParam){return sParameterName[1]===undefined?true:sParameterName[1];}}};var sprintNoFromURL=getUrlParameter("SprintNo");var iterationID=[];var iterationName=[];var iterationStart=[];var iterationEnd=[];var iterationStartReadable=[];var iterationEndReadable=[];var table=document.getElementById('sprintsTable')
var clickedPBIID;var date=new Date();var SprintResults=[];var PbiResults=[];var TaskResults=[];var board=$('#board');$.each(results,function(key,value){SprintResults=value[0];PbiResults=value[1];TaskResults=value[2];});$.each(SprintResults,function(key,value){var a=value.itID;var b=value.itName;var c=value.itStart;var d=value.itEnd;var e=value.itStartReadable;var f=value.itEndReadable;iterationID.push(a);iterationName.push(b);iterationStart.push(c);iterationEnd.push(d);iterationStartReadable.push(e);iterationEndReadable.push(f);});if(sprintNoFromURL==null){$("#currentSprints").addClass("SelectedSprintType");for(i=0;i<SprintResults.length;i++){var itStartDate=new Date(iterationStart[i]);var itEndDate=new Date(iterationEnd[i]);var itStartDateTitle=iterationStartReadable[i];var itEndDateTitle=iterationEndReadable[i];if(itEndDate>=date&&itStartDate<=date){$("#sprintsTable").append('<tr class="PBI">'+'<td style="display:none">'+iterationID[i]+'</td>'+'<td>'+iterationName[i]+'</td>'+'</tr>');$("h1",".twoThirdsWidth").append(iterationName[i]);$("h2",".twoThirdsWidth").append("Sprint Start: "+itStartDateTitle);$("h3",".twoThirdsWidth").append("Sprint End: "+itEndDateTitle);};};}else{var shortIterationName=[];for(i=0;i<iterationName.length;i++){var str=iterationName[i]
str=str.substring(str.indexOf("-")+2)
shortIterationName.push(str);}var clickedSprintArrayNo=shortIterationName.indexOf(sprintNoFromURL);$("#sprintsTable").append('<tr class="PBI">'+'<td style="display:none">'+iterationID[clickedSprintArrayNo]+'</td>'+'<td>'+iterationName[clickedSprintArrayNo]+'</td>'+'</tr>');};try{$.each(PbiResults,function(key,value){board.append('<div class="KanbanRow" data-pbiID='+value.pbiId+'>'+'<div id="PBI'+value.pbiId+'" class="kanbanColumn">'+'<div id="'+value.pbiId+'" class="PBIResult">'+'<div class="pbiTitle">'+value.pbiTitle+'</div>'+'</div>'+'</div><div id= "todo'+value.pbiId+'" class="todo">'+'</div><div id="inprogress'+value.pbiId+'" class="inprogress">'+'</div><div id="done'+value.pbiId+'" class="done">'+'</div>'+'</div>');});}catch(error){}try{$.each(TaskResults,function(key,value){if(value.stateID==7){if(value.photoAddress!=null){$('#todo'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<img src ='+value.photoAddress+'>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}else{$('#todo'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}}else if(value.stateID==8){if(value.photoAddress!=null){$('#inprogress'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<img src ='+value.photoAddress+'>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}else{$('#inprogress'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}}else if(value.stateID>=9){if(value.photoAddress!=null){$('#done'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<img src ='+value.photoAddress+'>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}else{$('#done'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}};});}catch(error){}$("#currentSprints").click(function(e){e.preventDefault();$(".SelectedSprintType").removeClass("SelectedSprintType");$("#currentSprints").addClass("SelectedSprintType");var rows=table.getElementsByTagName('tr').length;if(rows>1){for(i=rows-1;i>0;i--){table.deleteRow(i);}}else{}for(i=0;i<SprintResults.length;i++){var itEndDate=new Date(iterationEnd[i])
var itStartDate=new Date(iterationStart[i])
if(itEndDate>=date&&itStartDate<date){$("#sprintsTable").append('<tr class="PBI">'+'<td style="display:none">'+iterationID[i]+'</td>'+'<td>'+iterationName[i]+'</td>'+'</tr>');};};showSprintData();});$("#previousSprints").click(function(e){e.preventDefault();$(".SelectedSprintType").removeClass("SelectedSprintType");$("#previousSprints").addClass("SelectedSprintType");var rows=table.getElementsByTagName('tr').length;if(rows>1){for(i=rows-1;i>0;i--){table.deleteRow(i);}}else{}for(i=0;i<SprintResults.length;i++){var itEndDate=new Date(iterationEnd[i])
if(itEndDate<date){$("#sprintsTable").append('<tr class="PBI">'+'<td style="display:none">'+iterationID[i]+'</td>'+'<td>'+iterationName[i]+'</td>'+'</tr>');};};showSprintData();});$("#futureSprints").click(function(e){e.preventDefault();$(".SelectedSprintType").removeClass("SelectedSprintType");$("#futureSprints").addClass("SelectedSprintType");var rows=table.getElementsByTagName('tr').length;if(rows>1){for(i=rows-1;i>0;i--){table.deleteRow(i);}}else{}for(i=0;i<SprintResults.length;i++){var itStartDate=new Date(iterationStart[i])
if(itStartDate>date){$("#sprintsTable").append('<tr class="PBI">'+'<td style="display:none">'+iterationID[i]+'</td>'+'<td>'+iterationName[i]+'</td>'+'</tr>');};};showSprintData();});function showSprintData(){$(".PBI").click(function(e){e.preventDefault();clickedSprintID=e.target.parentNode.firstChild.textContent;$.ajax({type:"POST",url:"../php/SprintDetails.php",data:{postedSprintID:clickedSprintID,},dataType:"json",success:function load(sprintData){SprintDetails(sprintData);dragAndDrop();},error:function(){console.log('error')}});});return false;function SprintDetails(results){var sprintDetails=[];var taskDetails=[];var pbisForSprint=[];$('.KanbanRow').remove();$.each(results,function(key,value){sprintDetails=value[0]
taskDetails=value[1];pbisForSprint=value[2];});try{$.each(sprintDetails,function(key,value){$("h1",".twoThirdsWidth").empty().append(value.itName);$("h2",".twoThirdsWidth").empty().append("Sprint Start: "+value.itStartReadable);$("h3",".twoThirdsWidth").empty().append("Sprint End: "+value.itEndReadable);})}catch(error){}try{$.each(pbisForSprint,function(key,value){board.append('<div class="KanbanRow" data-pbiID='+value.pbiId+'>'+'<div id="PBI'+value.pbiId+'" class="kanbanColumn">'+'<div id="'+value.pbiId+'" class="PBIResult">'+'<div class="pbiTitle">'+value.pbiTitle+'</div>'+'</div>'+'</div><div id= "todo'+value.pbiId+'" class="todo">'+'</div><div id="inprogress'+value.pbiId+'" class="inprogress">'+'</div><div id="done'+value.pbiId+'" class="done">'+'</div>'+'</div>');});}catch(error){}try{$.each(taskDetails,function(key,value){if(value.stateID==7){if(value.photoAddress!=null){$('#todo'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<img src ='+value.photoAddress+'>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}else{$('#todo'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}}else if(value.stateID==8){if(value.photoAddress!=null){$('#inprogress'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<img src ='+value.photoAddress+'>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}else{$('#inprogress'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}}else if(value.stateID>=9){if(value.photoAddress!=null){$('#done'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<img src ='+value.photoAddress+'>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}else{$('#done'+value.pbiID).append('<div id="Task'+value.taskId+'" class="Task" draggable="true" data-pbiID='+value.pbiID+'>'+'<div class="cardTitle">'+value.taskTitle+'</div>'+'<p><strong>Priority:</strong> '+value.priorityDesc+'</p>'+'<p><strong>Assignee:</strong> '+value.assignee+'</p>'+'<p><strong>Time spent:</strong> '+value.taskHoursDone+'</p>'+'</div>');}};});}catch(error){}$('.Task').dblclick(function(e){location="./tasks.php?taskId="+this.id.substring(4)})
$('.PBIResult').dblclick(function(e){location="./backlog.php?PBIId="+this.id})};};$('.Task').dblclick(function(e){location="./tasks.php?taskId="+this.id.substring(4)})
$('.PBIResult').dblclick(function(e){location="./backlog.php?PBIId="+this.id})};function dragAndDrop(){$('.Task').on('dragstart',function(event){event.originalEvent.dataTransfer.setData("text/plain",event.target.getAttribute('id'));});$('.todo').on('dragover',function(event){event.preventDefault();});$('.inprogress').on('dragover',function(event){event.preventDefault();});$('.done').on('dragover',function(event){event.preventDefault();});$('Body').on('drop','.KanbanRow',function(event){event.preventDefault();event.stopImmediatePropagation();var notecard=event.originalEvent.dataTransfer.getData("text/plain");var taskPbiID=document.getElementById(notecard).dataset.pbiid;var rowPbiId=event.target.parentNode.dataset.pbiid;if(taskPbiID==rowPbiId){if($(event.target).attr('class')==='todo'){event.target.appendChild(document.getElementById(notecard));console.log('Moved to to do');changeTaskState(7,notecard);}else if($(event.target).attr('class')==='inprogress'){event.target.appendChild(document.getElementById(notecard));changeTaskState(8,notecard);console.log('Moved to in progress');}else if($(event.target).attr('class')==='done'){event.target.appendChild(document.getElementById(notecard));changeTaskState(10,notecard);console.log('Moved to done');}};});};function changeTaskState(stateID,taskName){$.ajax({type:"POST",url:"../php/ChangeTaskState.php",beforeSend:function(){$('#'+taskName).addClass("lock");document.getElementById(taskName).setAttribute("draggable","false");},data:{postedStateID:stateID,postedTaskName:taskName},dataType:"json",success:function(){},error:function(result){},complete:function(){$('#'+taskName).removeClass("lock");document.getElementById(taskName).setAttribute("draggable","true");}});}